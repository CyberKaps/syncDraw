name: Deploy Frontend

on:
  push:
    branches: [ prod ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: cyberkaps
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile.frontend
          push: true
          tags: cyberkaps/sync-frontend:${{ github.sha }},cyberkaps/sync-frontend:latest
          build-args: |
            NEXT_PUBLIC_HTTP_BACKEND_URL=${{ secrets.NEXT_PUBLIC_HTTP_BACKEND_URL }}
            NEXT_PUBLIC_WS_BACKEND_URL=${{ secrets.NEXT_PUBLIC_WS_BACKEND_URL }}

      - name: Deploy to VM via SSH
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/ssh_key
          chmod 600 ~/ssh_key
          ssh -o StrictHostKeyChecking=no -i ~/ssh_key ubuntu@18.207.131.147 << 'EOF'
            # Ensure Docker network exists
            docker network create draw-app-network || true
            
            # Pull latest frontend image
            docker pull cyberkaps/sync-frontend:latest
            
            # Stop and remove old container if exists
            docker stop sync-frontend || true
            docker rm sync-frontend || true
            
            # Run new frontend container
            docker run --name sync-frontend -d \
              --network draw-app-network \
              -p 3000:3000 \
              -e NEXT_PUBLIC_HTTP_BACKEND_URL="http://18.207.131.147:3001" \
              -e NEXT_PUBLIC_WS_BACKEND_URL="ws://18.207.131.147:8080" \
              --restart unless-stopped \
              cyberkaps/sync-frontend:latest

              

            # Reload Nginx to pick up changes (safe)
            sudo systemctl reload nginx

            
            # Clean up old images
            docker image prune -f
          EOF
          rm ~/ssh_key
